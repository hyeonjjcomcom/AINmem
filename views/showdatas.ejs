<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>데이터 조회: <%= dbName %> / <%= collectionName %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', 'Noto Sans KR', sans-serif;
    }
    .toggle-button {
      cursor: pointer;
      color: #2563eb;
      font-weight: 500;
      margin-top: 4px;
      display: inline-block;
    }
    .toggle-button:hover {
      color: #1d4ed8;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-slate-900">AIN MEMORY</h1>
      <p class="text-md text-slate-500 mt-1">
        Database: <span class="font-semibold text-slate-600"><%= dbName %></span> /
        Collection: <span class="font-semibold text-slate-600"><%= collectionName %></span>
      </p>
    </header>

    <main>
      <% if (data && data.length > 0) {
        const allKeys = new Set();
        data.forEach(item => {
          const doc = item.toObject ? item.toObject() : item;
          Object.keys(doc).forEach(key => allKeys.add(key));
        });
        const columns = Array.from(allKeys).filter(key => key !== '_id' && key !== '__v');
      %>
      <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-x-auto">
        <table class="min-w-full text-sm divide-y divide-slate-200 table-auto">
          <thead class="bg-slate-50">
            <tr>
              <% columns.forEach(key => { %>
              <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                <%= key %>
              </th>
              <% }); %>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-slate-200">
            <% data.forEach((item, rowIndex) => {
              const doc = item.toObject ? item.toObject() : item;
            %>
            <tr>
              <% columns.forEach((key, colIndex) => {
                let tdClasses = "px-6 py-4 align-top max-w-[400px]";
                if (key === 'id' || key === 'session_id') {
                  tdClasses += " whitespace-nowrap";
                }
              %>
              <td class="<%= tdClasses %>">
                <%
                  let value = doc[key] ?? '';
                  const isObject = typeof value === 'object' && value !== null;
                  if (isObject) {
                    value = JSON.stringify(value, null, 2);
                  }
                  const uniqueId = `content-${rowIndex}-${colIndex}`;
                %>
                <div class="value-wrapper">
                  <div id="<%= uniqueId %>" class="value-content max-h-24 overflow-hidden">
                    <div class="whitespace-pre-wrap break-words text-slate-700 font-sans"><%= value %></div>
                  </div>
                  <button data-target="<%= uniqueId %>" class="toggle-button hidden">더보기</button>
                </div>
              </td>
              <% }); %>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
      <% } else { %>
      <div class="text-center py-20">
        <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          aria-hidden="true">
          <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
        </svg>
        <h3 class="mt-2 text-lg font-medium text-slate-800">데이터가 없습니다</h3>
        <p class="mt-1 text-sm text-slate-500">컬렉션에 표시할 데이터가 존재하지 않습니다.</p>
      </div>
      <% } %>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.value-content').forEach(container => {
        if (container.scrollHeight > container.clientHeight) {
          const button = container.nextElementSibling;
          if (button?.classList.contains('toggle-button')) {
            button.classList.remove('hidden');
          }
        }
      });

      document.querySelectorAll('.toggle-button').forEach(button => {
        button.addEventListener('click', (e) => {
          const targetId = e.target.dataset.target;
          const container = document.getElementById(targetId);
          if (container) {
            container.classList.toggle('max-h-24');
            e.target.textContent = container.classList.contains('max-h-24') ? '더보기' : '숨기기';
          }
        });
      });
    });
  </script>
</body>
</html>
